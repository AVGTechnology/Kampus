{% extends "base.html" %}
{% block content %}
{% load static %}

<div class="content" style="background-color: #dbdbdb;">
    <div class="row infinite-container">
        {% for posts in posts %}
        <div class="col-md-6 infinite-item">
            <div style="background-color: #ffffff;">
                <br>
                <div class="row valign-wrapper space">
                    <div class="col s15">
                        <a href="{% url 'view_user_profile' posts.user.pk %}">
                            <img src={{posts.user.owner.image.url}}
                                 width="50px" height="50px"
                                 alt="" class="circle">
                        </a>
                    </div>
                    <div class="col s16">
                        <b>{{ posts.user}}</b>
                        <p><font color="#9e9e9e">{{ posts.user.owner.profession}}</font></p>
                    </div>
                </div>

                <div class="space">
                    <div class="">
                        <b>{{ posts.caption}}</b>
                    </div>
                    {% if posts.file.url|slice:"-4:" == ".mp4" %}
                    <video class="responsive-video" controls>
                        <source src={{posts.file.url}} type="video/mp4" style="max-width: 100%;">
                    </video>
                    {% else %}
                    <img class="responsive-img" src={{posts.file.url}} style="max-width: 100%;">
                    {% endif %}
                </div>
                <br>
                <div class="row valign-wrapper">
                    <div class="col s15">

                        {% if user in posts.like.all%}
                        <a href="{% url 'like' posts.pk %}">
                            <i class="waves-effect material-icons"
                               style="font-size: 30px; text-decoration: none; color: red;">favorite</i>
                        </a>
                        {% else %}
                        <a href="{% url 'like' posts.pk %}">
                            <i class="waves-effect material-icons"
                               style="font-size: 30px; text-decoration: none; color: #292929">favorite_border</i>
                        </a>
                        {% endif %}

                    </div>

                    <div class="col s15">
                        <a href="{% url 'comment_view' posts.pk %}">
                            <i class=" waves-effect material-icons"
                               style="font-size: 30px;  text-decoration: none; color: #292929">comment</i>
                        </a>
                    </div>

                    <div class="col s15">
                        <a href="{% url 'chat_page' posts.user.pk %}">
                            <i class="waves-effect material-icons"
                               style="font-size: 30px; text-decoration: none; color: #292929; transform: rotate(0deg);">send</i>
                        </a>
                    </div>

                    <div class="col s1">
                        <a href="{{posts.file.url}}" class="pull-right" download>
                            <i class=" waves-effect material-icons right"
                               style="font-size: 30px; text-decoration: none; color: #292929">file_download</i>
                        </a>
                    </div>

                </div>

                <div class="row valign-wrapper">
                    <div class="col s15">
                        <a href="{% url 'likes' posts.pk %}">
                            <b style="color: black;">{{posts.like.count}} likes</b>
                        </a>
                    </div>

                    <div class="col s15">
                        <a href="{% url 'comment_view' posts.pk %}">

                            View all comments

                        </a>
                    </div>
                </div>

                {% for comments in comments %}
                {% if comments.post == posts %}
                <b>{{comments.user}}</b> <font size='3px;' color="#9e9e9e;"> {{
                comments.comment|truncatewords:"5"}}</font><br>
                {% endif %}
                {% endfor %}
                <!-- <div class="container">
                    comments....
                 </div>-->

                <div class="row valign-wrapper">
                    <div class="col s15">
                        <img src={{profile.image.url}}
                             width="30px"
                             height="30px"
                             alt="" class="circle">
                    </div>

                    <a href="{% url 'comment_view' posts.pk %}">
                        <div class="col s15 chip">
                            <p><font color="gray">Add a comment...</font></p>
                        </div>
                    </a>
                    <br>
                    <div class="col s4">
                        <p class="right"><font color="gray">{{posts.timestamp|date:"D d M Y" }}</font></p>
                    </div>
                </div>

            </div>

        </div>
        {% endfor %}
    </div>
    {% if page_obj.has_next %}
    <a class="infinite-more-link" href="?page={{ page_obj.next_page_number }}"></a>
    {% endif %}
    <div class="d-flex justify-content-center" style="display:none;">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

</div>

<script type="text/javascript" src="{% static 'js/jquery-2.2.4.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/jquery.waypoints.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/infinite.min.js' %}"></script>
<script>
    var infinite = new Waypoint.Infinite({
        element: $('.infinite-container')[0],
        handler: function(direction) {

    },
    offset: 'bottom-in-view',

    onBeforePageLoad: function () {
    $('.spinner-border').show();
    },
    onAfterPageLoad: function () {
    $('.spinner-border').hide();
    }

    });

</script>

<p style="color:blue; display:none;" id="msg"></p>
<p style="color:blue; display:none;" id="token"></p>
<p style="color:green; display:none;" id="notis"></p>
<p style="color:red; display:none;" id="err"></p>

{% endblock %}

{% block javascript %}

<script>
        MsgElem = document.getElementById("msg");
        TokenElem = document.getElementById("token");
        NotisElem = document.getElementById("notis");
        ErrElem = document.getElementById("err");

        // Initialize Firebase
        // TODO: Replace with your project's customized code snippet

var firebaseConfig = {
    apiKey: "AIzaSyDrZRgm_9-xauyre5flvN_KxLLYqQ8MCv0",
    authDomain: "kampus-305500.firebaseapp.com",
    projectId: "kampus-305500",
    storageBucket: "kampus-305500.appspot.com",
    messagingSenderId: "968358554586",
    appId: "1:968358554586:web:f22fed2afe90864b5d6ee3",
    measurementId: "G-5FE0JQ1XEE"
  };
     firebase.initializeApp(firebaseConfig);

        const messaging = firebase.messaging();

        // Receive messages
      messaging.onMessage((payload) => {
      console.log('Message received. ', payload);
      // ...
     });


      messaging.usePublicVapidKey('BMc_Wye4mGlB5K76dN8Mdnt-4Fi-VyjjRzFpOdvlzuG8yelcS_HWNiCpjTLVRVkfunPIWYbCYRQwaHs0AJCRGNc');
        messaging
            .requestPermission()
            .then(function () {
                MsgElem.innerHTML = "Notification permission granted."
                console.log("Notification permission granted.");
                // get the token in the form of promise
                return messaging.getToken()
            })
            .then(function(token) {
                TokenElem.innerHTML = 'token is : ' + token
                console.log('token is :' + token);
                console.log('Sending token to server...');
                // TODO(developer): Send the current token to your server.
        $.ajax({
        type: "GET",
        url: '{% url 'fcm_token' %}',
        data: {
            "token": token,
        },
        dataType: "json",
        success: function (token) {
            // any process in data
            console.log("successfull");
        },
        failure: function () {
            console.log("failure");
        }
    });

        })
            .catch(function (err) {
                ErrElem.innerHTML =  ErrElem.innerHTML + "; " + err
                console.log("Unable to get permission to notify.", err);
            });



</script>
{% endblock javascript %}


















